
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Description...">
      
      
      
      
        <link rel="prev" href="../7pages/">
      
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.5.3, mkdocs-material-9.5.17">
    
    
      
        <title>Store - Helpbuttons.org</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.bcfcd587.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#store" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="Helpbuttons.org" class="md-header__button md-logo" aria-label="Helpbuttons.org" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Helpbuttons.org
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Store
            
          </span>
        </div>
      </div>
    </div>
    
    
      <script>var media,input,key,value,palette=__md_get("__palette");if(palette&&palette.color){"(prefers-color-scheme)"===palette.color.media&&(media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']"),palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent"));for([key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/helpbuttons/hb-docs" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Helpbuttons.org" class="md-nav__button md-logo" aria-label="Helpbuttons.org" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    Helpbuttons.org
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/helpbuttons/hb-docs" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Run Documentation
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Api scheme
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Castellano
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            Castellano
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_1" >
        
          
          <label class="md-nav__link" for="__nav_3_1" id="__nav_3_1_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Legacy
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_1">
            <span class="md-nav__icon md-icon"></span>
            Legacy
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Castellano/legacy/installation/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Instalaciones de Help Buttons
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" checked>
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    English
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            English
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Overview
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../10functionality/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Functionalities
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../11commit/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Commit Message Conventions
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../12issues%26PR/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Issues a& PR Policy
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../15contact/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Contact
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2philosophy/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Philosophy of the project
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../3buildCommunity/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Build Community
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../4features/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Features
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../5installation/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Installation Guide
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../6architecture/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Architecture
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../7pages/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Pages
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    Store
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    Store
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#declaring-the-global-state" class="md-nav__link">
    <span class="md-ellipsis">
      Declaring the global state
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#using-immer-to-efficiently-modify-data" class="md-nav__link">
    <span class="md-ellipsis">
      Using immer to efficiently modify data
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#using-events-to-change-the-state" class="md-nav__link">
    <span class="md-ellipsis">
      Using events to change the state
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#subscribing-to-state-changes" class="md-nav__link">
    <span class="md-ellipsis">
      Subscribing to state changes
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#using-asynchronous-events" class="md-nav__link">
    <span class="md-ellipsis">
      Using asynchronous events
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#modularizing-the-global-state" class="md-nav__link">
    <span class="md-ellipsis">
      Modularizing the global state
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#declaring-the-global-state" class="md-nav__link">
    <span class="md-ellipsis">
      Declaring the global state
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#using-immer-to-efficiently-modify-data" class="md-nav__link">
    <span class="md-ellipsis">
      Using immer to efficiently modify data
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#using-events-to-change-the-state" class="md-nav__link">
    <span class="md-ellipsis">
      Using events to change the state
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#subscribing-to-state-changes" class="md-nav__link">
    <span class="md-ellipsis">
      Subscribing to state changes
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#using-asynchronous-events" class="md-nav__link">
    <span class="md-ellipsis">
      Using asynchronous events
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#modularizing-the-global-state" class="md-nav__link">
    <span class="md-ellipsis">
      Modularizing the global state
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  
  


<h1 id="store">Store<a class="headerlink" href="#store" title="Permanent link">#</a></h1>
<p>A typical problem in web applications is how to share data between unrelated web components in one page. When a component is a child of another one, the parent may pass info with the properties. But if components that want to share data are scattered around the page, the question is more difficult.</p>
<p>In addition, when the interacions become more complex, a change of one piece of data, often triggers further changes elsewhere. Without care, this may lead to infinite loops or race conditions.</p>
<p>There are a number of solutions for these problems. Here we use the Store module, inspired in <a href="https://redux.js.org/">Redux</a> but much simpler to use, although quite powerful. It's based in two main contents:</p>
<ul>
<li>The <code>Store</code> holds a global state of the application. A tree of objects that may be changed by any component, and subscribed by any one to be notified of the changes.</li>
<li>The <code>Event</code> stream. When any component wants to modify the state, it does not directly write to the Store. Instead, emits an <code>Event</code>, that is queued and executed only when all other processes are finished. The event is an object with a function that receives the global state, and returns a new state with the desired changes.</li>
</ul>
<p>This way, loops and race conditions are avoided, the state being stable while any javascript event or component redraw is being executed.</p>
<h2 id="declaring-the-global-state">Declaring the global state<a class="headerlink" href="#declaring-the-global-state" title="Permanent link">#</a></h2>
<p>Define an interface with all the variables you need inside the global state. Then, declare ain instance of <code>Store</code>, generated from the given interface and with the initial data, and exported to be accessible from anywhere in the app:</p>
<pre><code class="language-typescript">// index.tsx

import { Store } from &quot;store/Store&quot;;

export interface GlobalState {
  loading: boolean,
  currentUser?: {
    username: string,
    name: string;
    email: string;
  }
}

export const store = new Store&lt;GlobalState&gt;({
  loading: false,
  currentUser: null,
});
</code></pre>
<h2 id="using-immer-to-efficiently-modify-data">Using immer to efficiently modify data<a class="headerlink" href="#using-immer-to-efficiently-modify-data" title="Permanent link">#</a></h2>
<p>The architecture explained here implies a lot of object cloning (to compliy with the immutable objects paradigm). To achieve this in an efficient way, we use the <a href="https://immerjs.github.io/immer/">immerjs</a> library. The main resource is the <code>produce</code> function, that takes an object and perform a shallow copy, but preserving all parts that have not changed. Example of usage:</p>
<pre><code class="language-typescript">import produce from &quot;immer&quot;;

const someObject = {
  one: 1,
  two: 2,
  letters: [&quot;a&quot;, &quot;b&quot;, &quot;c&quot;]
}

const newObject = produce(someObject, draft =&gt; {
  draft.one = 11;
  draft.letters.push(&quot;d&quot;);
});

// newObject is {one: 11, two: 2, letters: [&quot;a&quot;, &quot;b&quot;, &quot;c&quot;, &quot;d&quot;]}
// The structure of newObject shares any attribute that has not changed (in this case, `two`),
// to save memory and processing time.
</code></pre>
<h2 id="using-events-to-change-the-state">Using events to change the state<a class="headerlink" href="#using-events-to-change-the-state" title="Permanent link">#</a></h2>
<p>Define a class that implements <code>UpdateEvent</code>, with an <code>update</code> method that does the work. Then (inside a dom event handler, for example), use the <code>emit</code> method of the store to queue it to be executed later, when all other processing have stopped.</p>
<pre><code class="language-typescript">// SomeComponent/data.tsx

import { UpdateEvent } from &quot;store/Event&quot;;
import { GlobalState } from &quot;index&quot;;

export class SetLoadingEvent implements UpdateEvent {
  public constructor(private loading: boolean) {}

  public update(state: GlobalState) {
    return produce(state, newState =&gt; {
      newState.loading = this.loading;
    });
  }
}

// SomeComponent/index.tsx

import { store } from &quot;index&quot;;
import { SetLoadingEvent } from &quot;SomeComponent/data&quot;;

window.onload(() =&gt; store.emit(new SetLoadingEvent(true)));
</code></pre>
<p>In this example, after the <code>onload</code> event completely finishes, the global state is modified to set the <code>loading</code> variable to true. Then, the subscribers of this variable will be notified of the change (see below).</p>
<h2 id="subscribing-to-state-changes">Subscribing to state changes<a class="headerlink" href="#subscribing-to-state-changes" title="Permanent link">#</a></h2>
<p>The global state may be read synchronously, and it will give the current value at the moment it's read. But the usual way of reading it is not so, but subscribing to the state or to one part of it, and being notified whenever it changes.</p>
<p>The <code>Store</code> class has a public member named <code>state$</code>, that is a RX observable that you can subscribe to, and that emits the new state each time it's modified.</p>
<pre><code class="language-typescript">import { store, GlobalState } from &quot;index&quot;;

store.state$.subscribe((state: GlobalState) =&gt; {
  console.log(state.currentUser?.name);
}
</code></pre>
<p>But inside a React application, you usually will not need to subscribe directly to the state. Instead you'll use the <code>useRef</code> <a href="https://reactjs.org/docs/hooks-intro.html">React hook</a>. It's useful to subscribe to a subset of the state from a React component. You give it a function that selects the portion of the state you need, and the hook ensures that whenever this fragment changes, a componet repaint is triggered, with the value attached to a local variable.</p>
<pre><code class="language-typescript">// SomeComponent/index.tsx

import { useRef } from &quot;store/Store&quot;;
import { store } from &quot;index&quot;;

export default function SomeComponent() {
  const user = useRef(store, (state) =&gt; state.currentUser);

  return (
    (user &amp;&amp;
      &lt;div class=&quot;user-block&quot;&gt;
        &lt;p&gt;{ user.name }&lt;/p&gt;
        &lt;p&gt;{ user.email }&lt;/p&gt;
      &lt;/div&gt;)
  );
}
</code></pre>
<h2 id="using-asynchronous-events">Using asynchronous events<a class="headerlink" href="#using-asynchronous-events" title="Permanent link">#</a></h2>
<p>Often, you will need to trigger some action that is not immediate, but have to wait for something (for example, ask the backend for some data, or set a timer).</p>
<p>For this, you can use the <code>WatchEvent</code>. These kind of events also may be emitted, and have a function <code>watch</code> that receives the current global state value. But these ones return a RX observable, that emits one or more events before completting. The new events are then queued, to be executed when it's their turn. If the new events are UpdateEvents, the state will finally be modified. If they are also WatchEvents, more events will be queued in turn, extending the chain.</p>
<pre><code class="language-typescript">import { UpdateEvent } from &quot;store/Event&quot;;
import { GlobalState } from &quot;index&quot;;
import { ajax } from &quot;rxjs/ajax&quot;;

export class LoadUserEvent implements WatchEvent {
  public watch(state: GlobalState) {
    return ajax.getJSON(&quot;https://my.backend/api/current-user&quot;).pipe(
      map((user) =&gt; new UserLoadedEvent(user))
    );
  }
}

class UserLoadedEvent implements UpdateEvent {
  public constructor(private user: object) {}

  public update(state: GlobalState) {
    return produce(state, newState =&gt; {
      newState.currentUser = this.user;
    });
  }
}
</code></pre>
<p>An event may implement both <code>UpdateEvent</code> and <code>WatchEvent</code>. In this case, when the event is executed, the <code>update</code> function will be called first, and then <code>watch</code> will be called with the updated state.</p>
<pre><code class="language-typescript">import { UpdateEvent } from &quot;store/Event&quot;;
import { GlobalState } from &quot;index&quot;;
import { ajax } from &quot;rxjs/ajax&quot;;

export class LoadUserEvent implements UpdateEvent, WatchEvent {
  public update(state: GlobalState) {
    return produce(state, newState =&gt; {
      newState.loading = true;
    });
  }

  public watch(state: GlobalState) {
    return ajax.getJSON(&quot;https://my.backend/api/current-user&quot;).pipe(
      map((user) =&gt; new UserLoadedEvent(user))
    );
  }
}

class UserLoadedEvent implements UpdateEvent {
  public constructor(private user: object) {}

  public update(state: GlobalState) {
    return produce(state, newState =&gt; {
      newState.loading = false;
      newState.currentUser = this.user;
    });
  }
}

// LoadingComponent/index.tsx

import { useRef } from &quot;store/Store&quot;;
import { store } from &quot;index&quot;;

export default function LoadingComponent() {
  const loading = useRef(store, (state) =&gt; state.loading);

  return (
    (loading &amp;&amp;
      &lt;div class=&quot;loading&quot;&gt;
        &lt;img src=&quot;spinner.gif&quot; /&gt;
      &lt;/div&gt;)
  );
}
</code></pre>
<p>A third type of event is the <code>EffectEvent</code>. It's intended for when you need to trigger an external action (a 'side effect') but you don't need a return value.</p>
<pre><code class="language-typescript">import { EffectEvent } from &quot;store/Event&quot;;
import { GlobalState } from &quot;index&quot;;
import { ajax } from &quot;rxjs/ajax&quot;;

export class LogEntryEvent implements EffectEvent {
  public effect(state: GlobalState) {
    ajax.post(&quot;https://my.backend/api/log-entry&quot;, JSON.stringify({
      date: date.now(),
      user: state.user.username,
    }));
  }
}
</code></pre>
<h2 id="modularizing-the-global-state">Modularizing the global state<a class="headerlink" href="#modularizing-the-global-state" title="Permanent link">#</a></h2>
<p>When the applicatoin grows, it's not a good idea to have all state in a big global object with all variables in the same level. Te suggestion is to have each submodule its own definition of the local state, the initial values and the selecte function, and to aggregate all modules in the global state.</p>
<pre><code class="language-typescript">
// index.ts

import { Store } from &quot;store/Store&quot;;
import { UserState, userInitial } from &quot;user/data&quot;;
import { OtherState, otherInitial } from &quot;other/data&quot;;
...

export interface GlobalState {
  user: UserState,
  other: OtherState,
  ...
}

export const store = newStore&lt;GlobalState&gt;({
  user: userInitial,
  other: otherInitial,
  ...
});


// User/data.tsx

export interface UserState {
  loading: boolean,
  currentUser?: {
    username: string,
    name: string;
    email: string;
  }
}

export const userInitial = {
  loading: false,
  currentUser: null,
};

export getUser = (state) =&gt; state.user;


// User/index.tsx

import { useRef } from &quot;store/Store&quot;;
import { store } from &quot;index&quot;;
import { getUser } from &quot;./data&quot;;

export default function SomeComponent() {
  const user = useRef(store, (state) =&gt; state.getUser().currentUser);

  return (
    (user &amp;&amp;
      &lt;div class=&quot;user-block&quot;&gt;
        &lt;p&gt;{ user.name }&lt;/p&gt;
        &lt;p&gt;{ user.email }&lt;/p&gt;
      &lt;/div&gt;)
  );
}
</code></pre>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        <div class="md-social">
  
    
    
    
    
      
      
    
    <a href="https://gitlab.com/hb-dev/" target="_blank" rel="noopener" title="gitlab.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="m503.5 204.6-.7-1.8-69.7-181.78c-1.4-3.57-3.9-6.59-7.2-8.64-2.4-1.55-5.1-2.515-8-2.81-2.9-.295-5.7.083-8.4 1.11-2.7 1.02-5.1 2.66-7.1 4.78-1.9 2.12-3.3 4.67-4.1 7.44l-47 144H160.8l-47.1-144c-.8-2.77-2.2-5.31-4.1-7.43-2-2.12-4.4-3.75-7.1-4.77a18.1 18.1 0 0 0-8.38-1.113 18.4 18.4 0 0 0-8.04 2.793 18.09 18.09 0 0 0-7.16 8.64L9.267 202.8l-.724 1.8a129.57 129.57 0 0 0-3.52 82c7.747 26.9 24.047 50.7 46.447 67.6l.27.2.59.4 105.97 79.5 52.6 39.7 32 24.2c3.7 1.9 8.3 4.3 13 4.3 4.7 0 9.3-2.4 13-4.3l32-24.2 52.6-39.7 106.7-79.9.3-.3c22.4-16.9 38.7-40.6 45.6-67.5 8.6-27 7.4-55.8-2.6-82z"/></svg>
    </a>
  
    
    
    
    
      
      
    
    <a href="https://gitter.im/repo" target="_blank" rel="noopener" title="gitter.im" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 384 512"><!--! Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M66.4 322.5H16V0h50.4v322.5zM166.9 76.1h-50.4V512h50.4V76.1zm100.6 0h-50.4V512h50.4V76.1zM368 76h-50.4v247H368V76z"/></svg>
    </a>
  
    
    
    
    
      
      
    
    <a href="https://hub.docker.com/r/hb-dev" target="_blank" rel="noopener" title="hub.docker.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512"><!--! Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M349.9 236.3h-66.1v-59.4h66.1v59.4zm0-204.3h-66.1v60.7h66.1V32zm78.2 144.8H362v59.4h66.1v-59.4zm-156.3-72.1h-66.1v60.1h66.1v-60.1zm78.1 0h-66.1v60.1h66.1v-60.1zm276.8 100c-14.4-9.7-47.6-13.2-73.1-8.4-3.3-24-16.7-44.9-41.1-63.7l-14-9.3-9.3 14c-18.4 27.8-23.4 73.6-3.7 103.8-8.7 4.7-25.8 11.1-48.4 10.7H2.4c-8.7 50.8 5.8 116.8 44 162.1 37.1 43.9 92.7 66.2 165.4 66.2 157.4 0 273.9-72.5 328.4-204.2 21.4.4 67.6.1 91.3-45.2 1.5-2.5 6.6-13.2 8.5-17.1l-13.3-8.9zm-511.1-27.9h-66v59.4h66.1v-59.4zm78.1 0h-66.1v59.4h66.1v-59.4zm78.1 0h-66.1v59.4h66.1v-59.4zm-78.1-72.1h-66.1v60.1h66.1v-60.1z"/></svg>
    </a>
  
    
    
    
    
      
      
    
    <a href="https://twitter.com/helpbuttons" target="_blank" rel="noopener" title="twitter.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "../..", "features": [], "search": "../../assets/javascripts/workers/search.b8dbb3d2.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.1e8ae164.min.js"></script>
      
    
  </body>
</html>